<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
		<meta name="HandheldFriendly" content="true"/>
		<meta name="MobileOptimized" content="320"/>
		<title>Hello H5+</title>
		<link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8"/>
		<link rel="stylesheet" type="text/css" href="css/addr-info.css"/>
		<script src="js/config.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/zepto.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/touch.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/fx.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/template.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="js/fastclick.js" ></script>
		<script type="text/javascript" charset="utf-8">
		var ADDRINFO = {
			init:function(data){
				this.bindEvent();
				this.renderHead(data);
				setTimeout(function(){ADDRINFO.getData(data);},100);
				setTimeout(function(){ADDRINFO.getCommentData(data);},100);
			},
			renderHead : function(data){
				plus.storage.setItem('addrName',data.name);
				var htmlStr = template('infoHead',data);
				$('.info-head').html(htmlStr);
			},
			
			getData : function(data){
				var id  = data.id;
				var ajax = new plus.net.XMLHttpRequest();
				ajax.onreadystatechange = function () {
					var placeinfo = ADDRINFO;
					if(ajax.readyState==4&&ajax.status == 200){
						
						placeinfo.render(JSON.parse(ajax.responseText));
					}
				}
				
				ajax.open("GET",CONF.apiServer+'/?method=getPlaceInfo&id='+id);
				
				ajax.send();
			},
			render : function(data){
				var htmlStr = template('placeInfoTpl',data[0]);
				$('.info').html(htmlStr);
				$('.info').animate({opacity: 1},100,'ease-in')
			},
			getCommentData : function(data){
				var id  = data.id;
				var ajax = new plus.net.XMLHttpRequest();
				
				ajax.onreadystatechange = function () {
					if(ajax.readyState==4&&ajax.status == 200){
						ADDRINFO.renderComments(JSON.parse(ajax.responseText));
					}
				}
				ajax.open("GET",CONF.apiServer+'/?method=getNewOneAddrCommentById&id='+id);
				
				ajax.send();
			},
			renderComments : function(data){
				if(data[0].name!=null){
					var htmlStr = template('commentsTpl',data[0]);
					$('.commentsInfo').html(htmlStr);
					$('.commentsInfo').animate({opacity: 1},100,'ease-in');
				}
			},
			
			bindEvent : function(){
				window.back=function(){
					ws=plus.webview.currentWebview();
					if(window.plus){
						ws.close();
					}else if(history.length>1){
						history.back();
					}else{
						window.close();
					}
				};
				$(document.body).on('swipeRight',function(){
					plus.webview.currentWebview().close()
				})
				
				plus.key.addEventListener("backbutton",function(){
					back();
				},false);
				$('.add').on('click',function(){
					ADDRINFO.showInfo($('#addrHead'));
				});
				$('.commentsInfo').on('click',function(){
					ADDRINFO.showCommentList($('#addrHead'));
				});
			},
			
			add : function(){
				
			},
			sendMsg : function(){
			},
			showInfo : function($item){
				var data = {
					id:$item.data('id'),
					name:$item.data('name')
				}
				if(this.hasOpen){
					return;
				}
				if(window.plus){
					var openwn=plus.webview.create('addr-comment.html','addr-comment',{scrollIndicator:'none',scalable:false});
					openwn.addEventListener("loaded",function(){
						openwn.show("slide-in-bottom",300);
						openwn.evalJS('commentPageInit('+JSON.stringify(data)+')')
					})
					
					ADDRINFO.hasOpen = true;
					openwn.addEventListener("close",function(){//页面关闭后可再次打开
						ADDRINFO.hasOpen=false;
					},false);
				}else{
					var rootView = plus.webview.getWebviewById(plus.runtime.appid);
					rootView.open('addr-comment.html');
				}
			},
			showCommentList:function($item){
				var data = {
					id:$item.data('id'),
					name:$item.data('name')
				}
				if(this.hasOpen){
					return;
				}
				if(window.plus){
					var openwn=plus.webview.create('addr-comment-list.html','addr-comment-list',{scrollIndicator:'none',scalable:false});
					openwn.addEventListener("loaded",function(){
						openwn.show("slide-in-right",150);
						openwn.evalJS('addrCommentListPageInit('+JSON.stringify(data)+')')
					})
					
					ADDRINFO.hasOpen = true;
					openwn.addEventListener("close",function(){//页面关闭后可再次打开
						ADDRINFO.hasOpen=false;
					},false);
				}else{
					var rootView = plus.webview.getWebviewById(plus.runtime.appid);
					rootView.open('addr-comment-list.html');
				}
			}
		}
		function plusReady(){
			
		}
		
		function addrInfoPageInit(data){
			$(function(){
			FastClick.attach(document.body);
			if(window.plus){
				ADDRINFO.init(data);
			}else{
				document.addEventListener("plusready",function(){ADDRINFO.init(data)},false);
			}
			
			
		})	
		}
		
		</script>
	</head>
	<body>
		<header>
			<div class="nvbt iback-back" onclick="back();"></div>
			<div class="nvtt">详细信息</div>
		</header>
		
	<div class="wrap">
		<div class="info-content info-head">
			
		</div>
		<div class="info">
		加载中...
		</div>
		<div class="commentsInfo comment-info">加载中...</div>
		<div class="info-content info-foot">
			<a class="add" href="javascript:;">我要评价</a><a class="send" href="javascript:;">纠错</a>
		</div>
	</div>
	<script id="placeInfoTpl" type="text/html">
		<div class="info-content info-body">
				<div class="info-item" id="showLocation" >
					<img src="img/icon_location.png" style="width: 25px; height: 25px;display: inline-block; vertical-align: middle;"/>
					<span class="placeinfo" style="height: 25px;line-height: 25px;">{{addr}}</span>
					<img class="arrow-right" src="img/arrow_right.png" style="width: 7px; height: 11px;float: right;vertical-align: middle;display: inline-block; margin-top: 15px;"/>
				</div>
				<div class="info-item" id="Call">
					<img src="img/icon_call.png" style="margin-bottom: 10px;width: 25px; height: 25px;vertical-align: middle;"/>
					<span class="placeinfo">{{tel}}</span>
					<img class="arrow-right" src="img/arrow_right.png" style="width: 7px; height: 11px;float: right;vertical-align: middle;display: inline-block; margin-top: 15px;"/>
				</div>
		</div>
	</script>
	<script id="commentsTpl" type="text/html">
		<div class="info-title">评价</div>
		<div class="info-item" style="margin: 0px 5px;height: 100px;">
			<div class="info-row item-title" style="font-weight: bold;margin:5px 0px;;">
			  <span>{{name}}</span>
			</div>
			<div class="info-row">
			  <img src="img/star{{start}}0.png" width="77px" height="14"/>
			  <span class="span-right">{{time}}</span>
			</div>
			
			<div class="info-row">
				<div style="width: 80%;float: left;margin: 2px 0;">
				<span>{{comment}}</span>  
				</div>
				<div class="" style="width:20%;float: left;margin: 2px 0;">
					<img class="arrow-right" src="img/arrow_right.png" style="width: 7px; height: 11px;float: right;vertical-align: middle;display: inline-block; margin-top: 15px;"/>
				</div>
			</div>
		</div>
	</script>
	<script type="text/html" id="infoHead">
	  <div class="info-item" id="addrHead" data-id="{{id}}" data-name="{{name}}">
	  	<img  width="60em" height="60em" src="img/no_picture.png"/></div>
		<div class="info-item" style="padding-top: 5px;">
			<span class="info-text " style="display: inline-block; width: 200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">{{name}}</span>
			<div style="height: 8px;"></div>
			
		</div>
	</script>
		
	</body>
</html>